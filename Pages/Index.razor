@page "/"
@using PowerPlatformDashboard.Models
@using PowerPlatformDashboard.Services
@inject ICustomerConfigService CustomerConfigService
@inject IPowerPlatformApiService PowerPlatformApiService

<PageTitle>Power Platform Dashboard</PageTitle>

<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>üöÄ Power Platform Support Dashboard</h1>
        <div>
            <a href="/onboarding" class="btn btn-success me-2">
                üîó Customer Onboarding
            </a>
            <button class="btn btn-primary" @onclick="ShowAddCustomerModal">
                ‚ûï Add Customer Manually
            </button>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Select Customer</h5>
                    <select class="form-select" @onchange="OnCustomerChanged">
                        <option value="">-- Choose a customer --</option>
                        @foreach (var customer in _customers)
                        {
                            <option value="@customer.CustomerId">@customer.CustomerName</option>
                        }
                    </select>
                    
                    @if (_selectedCustomer != null)
                    {
                        <div class="mt-3">
                            <button class="btn btn-sm btn-warning me-2" @onclick="ShowEditCustomerModal">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="btn btn-sm btn-danger" @onclick="DeleteCustomer">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
        
        @if (_selectedCustomer != null)
        {
            <div class="col-md-8">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="mb-0">
                            <strong>@_selectedCustomer.CustomerName</strong>
                            <small class="text-muted ms-2">Tenant: @_selectedCustomer.TenantId</small>
                        </h6>
                    </div>
                </div>
            </div>
        }
    </div>

    @if (_dashboardData.IsLoading)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading dashboard data...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(_dashboardData.ErrorMessage))
    {
        <div class="alert alert-danger">
            <strong>Error:</strong> @_dashboardData.ErrorMessage
        </div>
    }
    else if (_selectedCustomer != null)
    {
        <!-- Environments Section -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üåç Environments (@_dashboardData.Environments.Count)</h5>
            </div>
            <div class="card-body">
                @if (_dashboardData.Environments.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Region</th>
                                    <th>State</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var env in _dashboardData.Environments)
                                {
                                    <tr>
                                        <td><strong>@env.DisplayName</strong></td>
                                        <td><span class="badge bg-info">@env.Type</span></td>
                                        <td>@env.Region</td>
                                        <td>
                                            <span class="badge @(env.State == "Succeeded" ? "bg-success" : "bg-warning")">
                                                @env.State
                                            </span>
                                        </td>
                                        <td>@env.CreatedTime.ToShortDateString()</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-muted">No environments found.</p>
                }
            </div>
        </div>

        <!-- Storage Warnings Section -->
        @if (_dashboardData.StorageWarnings.Any())
        {
            <div class="card mb-4">
                <div class="card-header bg-warning">
                    <h5 class="mb-0">‚ö†Ô∏è Storage Warnings (@_dashboardData.StorageWarnings.Count)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Entity</th>
                                    <th>Threshold (MB)</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var warning in _dashboardData.StorageWarnings)
                                {
                                    <tr>
                                        <td><span class="badge bg-secondary">@warning.StorageCategory</span></td>
                                        <td><strong>@warning.StorageEntity</strong></td>
                                        <td>
                                            @if (warning.Thresholds?.Any() == true)
                                            {
                                                @warning.Thresholds.First().ThresholdInMB
                                            }
                                        </td>
                                        <td>
                                            <span class="badge @(warning.IsActive ? "bg-success" : "bg-secondary")">
                                                @(warning.IsActive ? "Active" : "Inactive")
                                            </span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }

        <!-- Capacity Section -->
        @if (_dashboardData.CapacityData.Any())
        {
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üíæ Capacity & Storage</h5>
                </div>
                <div class="card-body">
                    @foreach (var capacity in _dashboardData.CapacityData)
                    {
                        <div class="mb-4">
                            <h6>@capacity.EnvironmentName</h6>
                            
                            <div class="mb-2">
                                <small>Database: @capacity.DatabaseConsumedGb.ToString("F2") GB / @capacity.DatabaseAllocatedGb.ToString("F2") GB</small>
                                <div class="progress">
                                    <div class="progress-bar @GetProgressBarClass(capacity.DatabasePercentUsed)" 
                                         role="progressbar" 
                                         style="width: @capacity.DatabasePercentUsed%">
                                        @capacity.DatabasePercentUsed%
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-2">
                                <small>File: @capacity.FileConsumedGb.ToString("F2") GB / @capacity.FileAllocatedGb.ToString("F2") GB</small>
                                <div class="progress">
                                    <div class="progress-bar @GetProgressBarClass(capacity.FilePercentUsed)" 
                                         role="progressbar" 
                                         style="width: @capacity.FilePercentUsed%">
                                        @capacity.FilePercentUsed%
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-2">
                                <small>Log: @capacity.LogConsumedGb.ToString("F2") GB / @capacity.LogAllocatedGb.ToString("F2") GB</small>
                                <div class="progress">
                                    <div class="progress-bar @GetProgressBarClass(capacity.LogPercentUsed)" 
                                         role="progressbar" 
                                         style="width: @capacity.LogPercentUsed%">
                                        @capacity.LogPercentUsed%
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Power Pages Scan Section -->
        @if (_dashboardData.ScanReports.Any())
        {
            <div class="card mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">üîí Power Pages Security Scans (@_dashboardData.ScanReports.Count)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Environment</th>
                                    <th>Website ID</th>
                                    <th>Score</th>
                                    <th>Findings</th>
                                    <th>Completed</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var report in _dashboardData.ScanReports)
                                {
                                    <tr>
                                        <td><strong>@report.EnvironmentId</strong></td>
                                        <td>@report.WebsiteId</td>
                                        <td>
                                            @if (report.Score.HasValue)
                                            {
                                                <span class="badge @(report.Score >= 80 ? "bg-success" : report.Score >= 60 ? "bg-warning" : "bg-danger")">
                                                    @report.Score.Value.ToString("F1")
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">N/A</span>
                                            }
                                        </td>
                                        <td>
                                            @if (report.FindingsCount.HasValue)
                                            {
                                                <span class="badge bg-info">@report.FindingsCount</span>
                                            }
                                        </td>
                                        <td>@(report.CompletedOn?.ToShortDateString() ?? "N/A")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    }

		<!-- Advisor Recommendations Section -->
@if (_dashboardData.AdvisorRecommendations?.Any() == true)
{
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white d-flex align-items-center justify-content-between">
            <h5 class="mb-0">üß† Advisor Recommendations (@_dashboardData.AdvisorRecommendations.Count)</h5>

            <div class="d-flex align-items-center">
                <input class="form-control form-control-sm me-2"
                       style="width: 240px"
                       placeholder="Filter by scenario‚Ä¶"
                       @bind="_advisorFilter" />
                <select class="form-select form-select-sm me-2" style="width: 180px" @bind="_advisorSort">
                    <option value="resources-desc">Resources (high ‚Üí low)</option>
                    <option value="resources-asc">Resources (low ‚Üí high)</option>
                    <option value="recent">Most recently refreshed</option>
                    <option value="stale">Most stale first</option>
                </select>
                <button class="btn btn-sm btn-outline-light" @onclick="ClearAdvisorFilters">Clear</button>
            </div>
        </div>

        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th style="width: 40%">Scenario</th>
                            <th class="text-end" style="width: 12%">Resources</th>
                            <th style="width: 20%">Last Refreshed</th>
                            <th style="width: 20%">Next Refresh</th>
                            <th style="width: 8%"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var rec in GetFilteredSortedAdvisorRecs())
                        {
                            var last = rec.Details?.LastRefreshedTimestamp;
                            var next = rec.Details?.ExpectedNextRefreshTimestamp;
                            var count = rec.Details?.ResourceCount ?? 0;
                            <tr>
                                <td>
                                    <strong>@rec.Scenario</strong><br />
                                    <small class="text-muted">@GetScenarioHint(rec.Scenario)</small>
                                </td>
                                <td class="text-end">
                                    <span class="badge @(count >= 50 ? "bg-danger" : count >= 10 ? "bg-warning" : "bg-success")">
                                        @count
                                    </span>
                                </td>
                                <td>
                                    @FormatDate(last)
                                    @if (IsStale(last))
                                    {
                                        <span class="badge bg-warning text-dark ms-2">Stale</span>
                                    }
                                </td>
                                <td>@FormatDate(next)</td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-primary"
                                            title="View recommendation details"
                                            @onclick="() => ToggleAdvisorDetails(rec.Scenario)">
                                        @(IsExpanded(rec.Scenario) ? "Hide" : "Details")
                                    </button>
                                </td>
                            </tr>
                            @if (IsExpanded(rec.Scenario))
                            {
                                <tr class="table-light">
                                    <td colspan="5">
                                        <div>
                                            <div class="mb-1"><strong>Scenario:</strong> @rec.Scenario</div>
                                            <div class="mb-1">
                                                <strong>Summary:</strong> @GetScenarioSummary(rec.Scenario)
                                            </div>
                                            <div class="text-muted">
                                                <em>Tip:</em> Use this to prioritise clean-up and prevention tasks
                                                (e.g. disable unused apps, reduce noisy flows, fix capacity hotspots).
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            @if (!GetFilteredSortedAdvisorRecs().Any())
            {
                <p class="text-muted mb-0">No recommendations match your current filter.</p>
            }
        </div>
    </div>
}

</div>

<!-- Add/Edit Customer Modal -->
@if (_showModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(_isEditMode ? "Edit Customer" : "Add Customer")</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Customer Name</label>
                        <input type="text" class="form-control" @bind="_editingCustomer.CustomerName" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tenant ID</label>
                        <input type="text" class="form-control" @bind="_editingCustomer.TenantId" />
                        <small class="text-muted">From Azure AD ‚Üí Overview</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Client ID</label>
                        <input type="text" class="form-control" @bind="_editingCustomer.ClientId" />
                        <small class="text-muted">From App Registration ‚Üí Overview</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Client Secret</label>
                        <input type="password" class="form-control" @bind="_editingCustomer.ClientSecret" />
                        <small class="text-muted">From App Registration ‚Üí Certificates & secrets</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveCustomer">Save</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<CustomerConfig> _customers = new();
    private CustomerConfig _selectedCustomer;
    private DashboardData _dashboardData = new();
    
    private bool _showModal = false;
    private bool _isEditMode = false;
    private CustomerConfig _editingCustomer = new();

// --- Advisor UI state ---
private string _advisorFilter = string.Empty;
private string _advisorSort = "resources-desc";
private HashSet<string> _advisorExpanded = new();

private void ClearAdvisorFilters()
{
    _advisorFilter = string.Empty;
    _advisorSort = "resources-desc";
    _advisorExpanded.Clear();
}

private IEnumerable<AdvisorRecommendation> GetFilteredSortedAdvisorRecs()
{
    var q = _dashboardData.AdvisorRecommendations.AsEnumerable();

    if (!string.IsNullOrWhiteSpace(_advisorFilter))
    {
        var f = _advisorFilter.Trim();
        q = q.Where(r => (r.Scenario ?? "").Contains(f, StringComparison.OrdinalIgnoreCase));
    }

    // Sort
    q = _advisorSort switch
    {
        "resources-asc"  => q.OrderBy(r => r.Details?.ResourceCount ?? 0),
        "recent"         => q.OrderByDescending(r => r.Details?.LastRefreshedTimestamp ?? DateTime.MinValue),
        "stale"          => q.OrderBy(r => r.Details?.LastRefreshedTimestamp ?? DateTime.MinValue),
        _                 => q.OrderByDescending(r => r.Details?.ResourceCount ?? 0), // resources-desc
    };

    return q;
}

private string FormatDate(DateTime? dt)
    => dt.HasValue ? dt.Value.ToString("yyyy-MM-dd HH:mm") : "‚Äî";

private bool IsStale(DateTime? lastRefreshedUtc)
{
    if (!lastRefreshedUtc.HasValue) return true;
    // Consider stale if older than 7 days
    return (DateTime.UtcNow - lastRefreshedUtc.Value).TotalDays > 7;
}

private void ToggleAdvisorDetails(string scenario)
{
    if (string.IsNullOrWhiteSpace(scenario)) return;
    if (!_advisorExpanded.Add(scenario))
        _advisorExpanded.Remove(scenario);
}

private bool IsExpanded(string scenario) => _advisorExpanded.Contains(scenario);

// Optional: tiny hints/summaries to make rows clearer (extend as you learn scenarios)
private string GetScenarioHint(string scenario) => scenario?.ToLower() switch
{
    var s when s.Contains("unused") => "Potentially unused or idle resources",
    var s when s.Contains("capacity") => "Capacity / storage optimisation",
    var s when s.Contains("security") => "Security posture and configuration",
    _ => "Operational recommendation"
};

private string GetScenarioSummary(string scenario) => scenario?.ToLower() switch
{
    var s when s.Contains("unused")   => "Review and retire unused apps/flows to reduce noise and cost.",
    var s when s.Contains("capacity") => "Investigate high consumption; archive or scale where appropriate.",
    var s when s.Contains("security") => "Tighten permissions, secrets, and environment policies.",
    _ => "Investigate affected resources and action the suggested fix."
};


    protected override void OnInitialized()
    {
        RefreshCustomers();
    }

    private void RefreshCustomers()
    {
        _customers = CustomerConfigService.GetAllCustomers();
    }

    private async Task OnCustomerChanged(ChangeEventArgs e)
    {
        var customerId = e.Value?.ToString();
        
        if (string.IsNullOrEmpty(customerId))
        {
            _selectedCustomer = null;
            _dashboardData = new DashboardData();
            return;
        }

        _selectedCustomer = CustomerConfigService.GetCustomer(customerId);
        _dashboardData = new DashboardData { IsLoading = true };
        
        StateHasChanged();
        
        _dashboardData = await PowerPlatformApiService.GetDashboardDataAsync(_selectedCustomer);
        
        StateHasChanged();
    }

    private void ShowAddCustomerModal()
    {
        _isEditMode = false;
        _editingCustomer = new CustomerConfig();
        _showModal = true;
    }

    private void ShowEditCustomerModal()
    {
        _isEditMode = true;
        _editingCustomer = new CustomerConfig
        {
            CustomerId = _selectedCustomer.CustomerId,
            CustomerName = _selectedCustomer.CustomerName,
            TenantId = _selectedCustomer.TenantId,
            ClientId = _selectedCustomer.ClientId,
            ClientSecret = _selectedCustomer.ClientSecret
        };
        _showModal = true;
    }

    private void CloseModal()
    {
        _showModal = false;
    }

    private void SaveCustomer()
    {
        if (_isEditMode)
        {
            CustomerConfigService.UpdateCustomer(_editingCustomer);
        }
        else
        {
            CustomerConfigService.AddCustomer(_editingCustomer);
        }
        
        RefreshCustomers();
        CloseModal();
    }

    private void DeleteCustomer()
    {
        if (_selectedCustomer != null)
        {
            CustomerConfigService.DeleteCustomer(_selectedCustomer.CustomerId);
            _selectedCustomer = null;
            _dashboardData = new DashboardData();
            RefreshCustomers();
        }
    }

    private string GetProgressBarClass(int percent)
    {
        if (percent >= 90) return "bg-danger";
        if (percent >= 75) return "bg-warning";
        return "bg-success";
    }
}